<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Module - Architecture Diagrams</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 40px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .diagram-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .diagram-section h2 {
            color: #4F46E5;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        .diagram-section p {
            color: #6B7280;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        .mermaid {
            display: flex;
            justify-content: center;
            overflow-x: auto;
            padding: 20px 0;
        }
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        .nav {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .nav a {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            transition: background 0.3s;
        }
        .nav a:hover {
            background: rgba(255,255,255,0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Scoreboard Module Diagrams</h1>
        
        <nav class="nav">
            <a href="#sequence">Sequence Flow</a>
            <a href="#architecture">System Architecture</a>
            <a href="#security">Security Flow</a>
        </nav>

        <section id="sequence" class="diagram-section">
            <h2>1. Score Update Sequence Flow</h2>
            <p>Shows the complete flow from action start ‚Üí score update ‚Üí WebSocket broadcast to all clients.</p>
            <div class="mermaid">
sequenceDiagram
    autonumber
    participant C as Client<br/>(Browser)
    participant GW as API Gateway
    participant Auth as Auth Middleware
    participant SC as Score Controller
    participant SS as Score Service
    participant Redis as Redis Cache
    participant DB as PostgreSQL
    participant PubSub as Redis Pub/Sub
    participant WS as WebSocket Handler
    participant Clients as Connected Clients

    Note over C,Clients: Phase 1: Action Start (Get Action Token)
    
    C->>+GW: POST /api/v1/actions/start
    GW->>+Auth: Validate JWT Token
    Auth-->>-GW: User Authenticated
    GW->>+SC: Create Action Request
    SC->>+SS: Generate Action Token
    SS->>Redis: Store Token (5 min TTL)
    Redis-->>SS: OK
    SS-->>-SC: Action Token
    SC-->>-GW: Response
    GW-->>-C: { action_token, action_id }

    Note over C: User Performs Action<br/>(Game, Task, etc.)

    Note over C,Clients: Phase 2: Score Update

    C->>+GW: POST /api/v1/scores/update<br/>Headers: JWT + Action Token<br/>Body: action_id, score_delta, checksum
    
    rect rgb(254, 243, 199)
        Note over GW,Auth: Security Validation Layer
        GW->>+Auth: Validate Request
        Auth->>Auth: 1. Verify JWT Token
        Auth->>Auth: 2. Check Rate Limits
        Auth->>Redis: 3. Validate Action Token
        Redis-->>Auth: Token Valid & Unused
        Auth->>Auth: 4. Verify Checksum
        Auth-->>-GW: Validation Passed
    end

    GW->>+SC: Process Score Update
    SC->>+SS: Update Score

    rect rgb(220, 252, 231)
        Note over SS,DB: Score Processing
        SS->>DB: BEGIN TRANSACTION
        SS->>DB: Update user_scores
        SS->>DB: Insert score_transaction
        DB-->>SS: Commit Success
    end

    rect rgb(224, 231, 255)
        Note over SS,Redis: Cache & Leaderboard Update
        SS->>Redis: ZADD leaderboard:top (user_id, new_score)
        Redis-->>SS: OK
        SS->>Redis: ZREVRANK leaderboard:top (check if in top 10)
        Redis-->>SS: Rank (or nil)
    end

    SS->>Redis: Mark Action Token Used

    alt User in Top 10
        rect rgb(254, 226, 226)
            Note over SS,Clients: Real-time Broadcast
            SS->>PubSub: PUBLISH leaderboard:updates
            PubSub->>WS: Leaderboard Changed Event
            WS->>Redis: ZREVRANGE leaderboard:top 0 9 (fetch new top 10)
            Redis-->>WS: Top 10 Users
            WS->>Clients: WebSocket Broadcast { type: LEADERBOARD_UPDATE }
        end
    end

    SS-->>-SC: Updated Score + Rank
    SC-->>-GW: Response
    GW-->>-C: { new_score, rank, timestamp }

    Note over C,Clients: Phase 3: Live Updates (Ongoing)

    loop Heartbeat Every 30s
        C->>WS: PING
        WS->>C: PONG
    end
            </div>
        </section>

        <section id="architecture" class="diagram-section">
            <h2>2. System Architecture</h2>
            <p>High-level view of all system components: clients, gateway, application server, and data layer.</p>
            <div class="mermaid">
flowchart TB
    subgraph ClientLayer["üåê Client Layer"]
        Browser1["Browser (User A)"]
        Browser2["Browser (User B)"]
        Browser3["Browser (User N)"]
    end

    subgraph Gateway["‚ö° API Gateway / Load Balancer"]
        LB["Load Balancer<br/>+ TLS Termination<br/>+ DDoS Protection"]
    end

    subgraph AppServer["üñ•Ô∏è Application Server Cluster"]
        subgraph Middleware["Security Middleware"]
            JWT["JWT Validator"]
            ActionToken["Action Token<br/>Validator"]
            RateLimit["Rate Limiter"]
            Checksum["Checksum<br/>Validator"]
        end

        subgraph Controllers["Controllers"]
            ScoreCtrl["Score<br/>Controller"]
            LeaderboardCtrl["Leaderboard<br/>Controller"]
            ActionCtrl["Action<br/>Controller"]
        end

        subgraph Services["Business Services"]
            ScoreSvc["Score Service"]
            LeaderboardSvc["Leaderboard<br/>Service"]
            NotificationSvc["Notification<br/>Service"]
        end

        subgraph WebSocket["WebSocket Layer"]
            WSHandler["WebSocket<br/>Handler"]
            WSManager["Connection<br/>Manager"]
        end
    end

    subgraph DataLayer["üíæ Data Layer"]
        subgraph Cache["Redis Cluster"]
            LeaderboardCache["Sorted Set<br/>leaderboard:top"]
            TokenStore["Hash<br/>action_tokens"]
            RateLimitStore["Counter<br/>rate_limits"]
            PubSub["Pub/Sub<br/>leaderboard:updates"]
        end

        subgraph Database["PostgreSQL"]
            UserScores["user_scores<br/>table"]
            ScoreTransactions["score_transactions<br/>table"]
            AuditLog["audit_log<br/>table"]
        end
    end

    Browser1 -->|"REST API<br/>HTTPS"| LB
    Browser2 -->|"WebSocket<br/>WSS"| LB
    Browser3 -->|"REST/WS"| LB

    LB --> JWT

    JWT --> ActionToken
    ActionToken --> RateLimit
    RateLimit --> Checksum
    Checksum --> ScoreCtrl
    Checksum --> LeaderboardCtrl
    Checksum --> ActionCtrl

    ScoreCtrl --> ScoreSvc
    LeaderboardCtrl --> LeaderboardSvc
    ActionCtrl --> ScoreSvc

    ScoreSvc --> LeaderboardCache
    ScoreSvc --> UserScores
    ScoreSvc --> ScoreTransactions
    ScoreSvc --> PubSub
    
    LeaderboardSvc --> LeaderboardCache
    
    NotificationSvc --> PubSub

    LB -->|"WS Connection"| WSHandler
    WSHandler --> WSManager
    PubSub -->|"Subscribe"| WSHandler
    WSHandler -->|"Broadcast"| Browser1
    WSHandler -->|"Broadcast"| Browser2
    WSHandler -->|"Broadcast"| Browser3

    ActionToken -.->|"Validate"| TokenStore
    RateLimit -.->|"Check/Increment"| RateLimitStore
            </div>
        </section>

        <section id="security" class="diagram-section">
            <h2>3. Security Validation Flow</h2>
            <p>The 5-layer security pipeline that every score update request must pass through.</p>
            <div class="mermaid">
flowchart TB
    subgraph Request["üì® Incoming Request"]
        Req["POST /api/v1/scores/update<br/>Headers: Authorization, X-Action-Token<br/>Body: action_id, score_delta, checksum"]
    end

    subgraph Layer1["üîê Layer 1: Authentication"]
        JWT{"JWT Token<br/>Valid?"}
        JWTCheck["‚Ä¢ Check signature<br/>‚Ä¢ Verify expiration<br/>‚Ä¢ Extract user_id"]
    end

    subgraph Layer2["üé´ Layer 2: Action Token Verification"]
        Token{"Action Token<br/>Valid?"}
        TokenCheck["‚Ä¢ Verify signature<br/>‚Ä¢ Check not expired<br/>‚Ä¢ Confirm not used<br/>‚Ä¢ Match user_id"]
    end

    subgraph Layer3["üî¢ Layer 3: Request Integrity"]
        Checksum{"Checksum<br/>Matches?"}
        ChecksumCalc["‚Ä¢ Compute HMAC-SHA256<br/>‚Ä¢ Compare with client checksum<br/>‚Ä¢ Validate score_delta bounds"]
    end

    subgraph Layer4["‚è±Ô∏è Layer 4: Rate Limiting"]
        RateLimit{"Within<br/>Rate Limit?"}
        RateLimitCheck["‚Ä¢ Check user limit (10/min)<br/>‚Ä¢ Check IP limit (100/min)<br/>‚Ä¢ Check global circuit breaker"]
    end

    subgraph Layer5["‚úÖ Layer 5: Server Validation"]
        ServerVal{"Server<br/>Validation OK?"}
        ServerValCheck["‚Ä¢ Verify action_id exists<br/>‚Ä¢ Validate score_delta for action type<br/>‚Ä¢ Check for anomalies"]
    end

    subgraph Success["‚ú® Score Update"]
        Process["Process Score Update<br/>Update Database<br/>Update Leaderboard<br/>Broadcast Changes"]
    end

    subgraph Errors["‚ùå Error Responses"]
        E401["401 UNAUTHORIZED"]
        E403_Token["403 INVALID_ACTION_TOKEN"]
        E403_Checksum["403 CHECKSUM_MISMATCH"]
        E429["429 RATE_LIMITED"]
        E400["400 INVALID_REQUEST"]
    end

    Req --> JWTCheck
    JWTCheck --> JWT
    JWT -->|"‚ùå Invalid"| E401
    JWT -->|"‚úÖ Valid"| TokenCheck
    
    TokenCheck --> Token
    Token -->|"‚ùå Invalid/Used/Expired"| E403_Token
    Token -->|"‚úÖ Valid"| ChecksumCalc
    
    ChecksumCalc --> Checksum
    Checksum -->|"‚ùå Mismatch"| E403_Checksum
    Checksum -->|"‚úÖ Match"| RateLimitCheck
    
    RateLimitCheck --> RateLimit
    RateLimit -->|"‚ùå Exceeded"| E429
    RateLimit -->|"‚úÖ Within Limit"| ServerValCheck
    
    ServerValCheck --> ServerVal
    ServerVal -->|"‚ùå Invalid"| E400
    ServerVal -->|"‚úÖ Valid"| Process
            </div>
        </section>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true,
                showSequenceNumbers: true
            }
        });
    </script>
</body>
</html>
